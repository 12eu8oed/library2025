<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LibTime - 도서관 시간 확인 앱</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            max-width: 768px;
            margin: 0 auto;
            background-color: #f5f5f5;
            min-height: 100vh;
            position: relative;
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            max-width: 768px;
            margin: 0 auto;
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        header p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .main-content {
            padding: 80px 15px 20px;
        }

        .search-section {
            background-color: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 1.5px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 10px;
            -webkit-appearance: none;
        }

        .search-input:focus {
            outline: none;
            border-color: #2c3e50;
        }

        select {
            width: 100%;
            padding: 12px 15px;
            border: 1.5px solid #ddd;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 1rem;
            background-color: white;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232c3e50' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 15px;
        }

        select:focus {
            outline: none;
            border-color: #2c3e50;
        }

        button {
            width: 100%;
            padding: 15px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        button:active {
            background-color: #34495e;
        }

        .map-container {
            height: 200px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .library-list {
            padding-bottom: 20px;
        }

        .library-card {
            background-color: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            cursor: pointer;
        }

        .library-card:active {
            transform: scale(0.98);
        }

        .library-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .status-open {
            background-color: #27ae60;
            color: white;
        }

        .status-closed {
            background-color: #e74c3c;
            color: white;
        }

        .library-info {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.6;
        }

        .library-info p {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal-content {
            background-color: #fff;
            margin: 60px 15px 20px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            padding: 20px;
            background-color: #2c3e50;
            color: white;
            position: relative;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-right: 40px;
        }

        .close-modal {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
        }

        .detail-map {
            height: 200px;
            width: 100%;
        }

        .detail-info {
            padding: 20px;
        }

        .detail-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .detail-section:last-child {
            margin-bottom: 0;
        }

        .detail-section h3 {
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.95rem;
            color: #666;
        }

        .detail-item:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            flex-shrink: 0;
            width: 24px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #666;
            font-size: 1rem;
            background-color: white;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .no-results {
            text-align: center;
            padding: 30px;
            color: #666;
            font-size: 1rem;
            background-color: white;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        @media (min-width: 769px) {
            body {
                background-color: #2c3e50;
            }

            body > div {
                background-color: #f5f5f5;
                min-height: 100vh;
            }
        }

        .filter-button {
            width: 100%;
            padding: 15px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .filter-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .filter-content.show {
            max-height: 1000px;
            transition: max-height 0.3s ease-in;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .arrow {
            transition: transform 0.3s;
        }

        .arrow.up {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>LibTime</h1>
            <p>가까운 도서관 운영시간 확인</p>
        </header>

        <div class="main-content">
            <div class="search-section">
                <button class="filter-button" onclick="toggleFilters()">
                    검색 필터
                    <span class="arrow">▼</span>
                </button>
                <div class="filter-content">
                    <div class="filter-group">
                        <input type="text" class="search-input" id="libraryName" placeholder="도서관 이름 검색">

                        <select id="sido" onchange="updateSigungu()">
                            <option value="">시/도 선택</option>
                            <option value="서울특별시">서울특별시</option>
                            <option value="부산광역시">부산광역시</option>
                            <option value="대구광역시">대구광역시</option>
                            <option value="인천광역시">인천광역시</option>
                            <option value="광주광역시">광주광역시</option>
                            <option value="대전광역시">대전광시</option>
                            <option value="울산광역시">울산광역시</option>
                            <option value="세종특별자치시">세종특별자치시</option>
                            <option value="경기도">경기도</option>
                            <option value="강원도">강원도</option>
                            <option value="충청북도">충청북도</option>
                            <option value="충청남도">충청남도</option>
                            <option value="전라북도">전라북도</option>
                            <option value="전라남도">전라남도</option>
                            <option value="경상북도">경상북도</option>
                            <option value="경상남도">경상남도</option>
                            <option value="제주특별자치도">제주특별자치도</option>
                        </select>

                        <select id="sigungu">
                            <option value="">시/군/구 선택</option>
                        </select>

                        <select id="weekdayTime">
                            <option value="">평일 운영시간 선택</option>
                            <option value="13:00">13시까지</option>
                            <option value="14:00">14시까지</option>
                            <option value="15:00">15시까지</option>
                            <option value="16:00">16시까지</option>
                            <option value="17:00">17시까지</option>
                            <option value="18:00">18시까지</option>
                            <option value="19:00">19시까지</option>
                            <option value="20:00">20시까지</option>
                            <option value="21:00">21시까지</option>
                            <option value="22:00">22시까지</option>
                            <option value="23:00">23시까지</option>
                        </select>

                        <select id="weekendTime">
                            <option value="">주말 운영시간 선택</option>
                            <option value="13:00">13시까지</option>
                            <option value="14:00">14시까지</option>
                            <option value="15:00">15시까지</option>
                            <option value="16:00">16시까지</option>
                            <option value="17:00">17시까지</option>
                            <option value="18:00">18시까지</option>
                            <option value="19:00">19시까지</option>
                            <option value="20:00">20시까지</option>
                            <option value="21:00">21시까지</option>
                            <option value="22:00">22시까지</option>
                            <option value="23:00">23시까지</option>
                        </select>

                        <select id="closeDay">
                            <option value="">휴관일 선택</option>
                            <option value="월">월요일</option>
                            <option value="화">화요일</option>
                            <option value="수">수요일</option>
                            <option value="목">목요일</option>
                            <option value="금">금요일</option>
                            <option value="토">토요일</option>
                            <option value="일">일요일</option>
                        </select>
                    </div>
                    <button onclick="searchLibraries()">도서관 검색</button>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
            </div>

            <div id="results" class="library-list">
                <!-- 검색 결과가 여기에 표시됩니다 -->
            </div>
        </div>
    </div>

    <!-- 모달 -->
    <div id="libraryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">도서관 상세 정보</h2>
                <button class="close-modal" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body">
                <div id="detailMap" class="detail-map"></div>
                <div class="detail-info">
                    <div class="detail-section">
                        <h3>📍 위치 정보</h3>
                        <div id="locationInfo"></div>
                    </div>
                    <div class="detail-section">
                        <h3>⏰ 운영 시간</h3>
                        <div id="operationInfo"></div>
                    </div>
                    <div class="detail-section">
                        <h3>📚 도서관 정보</h3>
                        <div id="libraryInfo"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 지도 초기화
        const map = L.map('map').setView([37.5665, 126.9780], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let markers = [];
        let detailMap = null;

        const sigunguData = {
            "서울특별시": ["강남구", "강동구", "강북구", "강서구", "관악구", "광진구", "구로구", "금천구", "노원구", "도봉구", "동대문구", "동작구", "마포구", "서대문구", "서초구", "성동구", "성북구", "송파구", "양천구", "영등포구", "용산구", "은평구", "종로구", "중구", "중랑구"],
            "부산광역시": ["강서구", "금정구", "남구", "동구", "동래구", "부산진구", "북구", "사상구", "사하구", "서구", "수구", "연제구", "영도구", "중구", "해운대구", "기장군"],
            "대구광역시": ["남구", "달서구", "동구", "북구", "서구", "수성구", "중구", "달성군"],
            "인천광역시": ["계양구", "남동구", "동구", "미추홀구", "부평구", "서구", "연수구", "중구", "강화군", "옹진군"],
            "광주광역시": ["광산구", "남구", "동구", "북구", "서구"],
            "대전광역시": ["대덕구", "동구", "서구", "유성구", "중구"],
            "울산광역시": ["남구", "동구", "북구", "중구", "울주군"],
            "세종특별자치시": ["세종시"],
            "경기도": ["고양시", "과천시", "광명시", "광주시", "구리시", "군포시", "김포시", "남양주시", "동두천시", "부천시", "성남시", "수원시", "시흥시", "안산시", "안성시", "안양시", "양주시", "오산시", "용인시", "의왕시", "의정부시", "이천시", "파주시", "평택시", "포천시", "하남시", "화성시", "가평군", "양평군", "여주시", "연천군"],
            "강원도": ["강릉시", "동해시", "삼척시", "속초시", "원주시", "춘천시", "태백시", "고성군", "양구군", "양양군", "영월군", "인제군", "정선군", "철원군", "평창군", "홍천군", "화천군", "횡성군"],
            "충청북도": ["제천시", "청주시", "충주시", "괴산군", "단양군", "보은군", "영동군", "옥천군", "음성군", "증평군", "진천군"],
            "충청남도": ["계룡시", "공주시", "논산시", "당진시", "보령시", "서산시", "아산시", "천안시", "금산군", "부여군", "서천군", "예산군", "청양군", "태안군", "홍성군"],
            "전라북도": ["군산시", "김제시", "남원시", "익산시", "전주시", "정읍시", "고창군", "무주군", "부안군", "순창군", "완주군", "임실군", "장수군", "진안군"],
            "전라남도": ["광양시", "나주시", "목포시", "순천시", "여수시", "강진군", "고흥군", "곡성군", "구례군", "담양군", "무안군", "보성군", "신안군", "영광군", "영암군", "완도군", "장성군", "장흥군", "진도군", "함평군", "해남군", "화순군"],
            "경상북도": ["경산시", "경주시", "구미시", "김천시", "문경시", "상주시", "안양시", "영주시", "영천시", "포항시", "고령군", "군위군", "봉화군", "성주군", "영덕군", "영양군", "예천군", "울릉군", "울진군", "의성군", "청도군", "청송군", "칠곡군"],
            "경상남도": ["거제시", "김해시", "밀양시", "사천시", "양산시", "진주시", "창원시", "통영시", "거창군", "고성군", "남해군", "산청군", "의창군", "창녕군", "하동군", "함안군", "함양군", "합천군"],
            "제주특별자치도": ["제주시", "서귀포시"]
        };

        function updateSigungu() {
            const sido = document.getElementById('sido').value;
            const sigunguSelect = document.getElementById('sigungu');
            
            sigunguSelect.innerHTML = '<option value="">시/군/구 선택</option>';
            
            if (sido && sigunguData[sido]) {
                sigunguData[sido].forEach(sigungu => {
                    const option = document.createElement('option');
                    option.value = sigungu;
                    option.textContent = sigungu;
                    sigunguSelect.appendChild(option);
                });
            }
        }

        function toggleFilters() {
            const filterContent = document.querySelector('.filter-content');
            const arrow = document.querySelector('.arrow');
            filterContent.classList.toggle('show');
            arrow.classList.toggle('up');
        }

        async function searchLibraries() {
            const libraryName = document.getElementById('libraryName').value;
            const sido = document.getElementById('sido').value;
            const sigungu = document.getElementById('sigungu').value;
            const weekdayTime = document.getElementById('weekdayTime').value;
            const weekendTime = document.getElementById('weekendTime').value;
            const closeDay = document.getElementById('closeDay').value;

            const serviceKey = 'PBIpP/4F7bIX49M48pfiKnpB91ZqeeFNiUcNLLCXtbaHIVFuMVF+rGv0MQnSHbdY7QK4UW1lvRgdBtAjz4qeEQ==';
            
            let url = `http://api.data.go.kr/openapi/tn_pubr_public_lbrry_api`;
            url += `?serviceKey=${encodeURIComponent(serviceKey)}`;
            url += `&pageNo=0&numOfRows=1000&type=json`;
            
            if (libraryName) url += `&lbrryNm=${encodeURIComponent(libraryName)}`;
            if (sido) url += `&CTPRVN_NM=${encodeURIComponent(sido)}`;
            if (sigungu) url += `&SIGNGU_NM=${encodeURIComponent(sigungu)}`;
            if (weekdayTime) url += `&weekdayOperColseHhmm=${weekdayTime}`;
            if (weekendTime) url += `&satOperCloseHhmm=${weekendTime}`;

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">검색중...</div>';

            try {
                const response = await fetch(url);
                const data = await response.json();
                let libraries = data.response.body.items;

                // 휴관일 필터링
                if (closeDay && libraries) {
                    libraries = libraries.filter(lib => 
                        lib.closeDay && lib.closeDay.includes(closeDay)
                    );
                }

                displayResults(libraries || []);
            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML = '<div class="no-results">검색 결과가 없습니다.</div>';
            }
        }

        function showModal(library) {
            const modal = document.getElementById('libraryModal');
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';

            // 모달 제목 설정
            document.querySelector('.modal-title').textContent = library.lbrryNm;

            // 위치 정보 설정
            const locationInfo = document.getElementById('locationInfo');
            locationInfo.innerHTML = `
                <div class="detail-item">
                    <span class="detail-label">📍</span>
                    <span>${library.rdnmadr || library.lnmadr}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">📞</span>
                    <span>${library.phoneNumber}</span>
                </div>
            `;

            // 운영 시간 정보 설정
            const operationInfo = document.getElementById('operationInfo');
            operationInfo.innerHTML = `
                <div class="detail-item">
                    <span class="detail-label">🌞</span>
                    <span>평일: ${library.weekdayOperOpenHhmm} - ${library.weekdayOperColseHhmm}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">🌅</span>
                    <span>주말: ${library.satOperOperOpenHhmm || '휴관'} - ${library.satOperCloseHhmm || '휴관'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">🚫</span>
                    <span>휴관일: ${library.closeDay}</span>
                </div>
            `;

            // 도서관 정보 설정
            const libraryInfo = document.getElementById('libraryInfo');
            libraryInfo.innerHTML = `
                <div class="detail-item">
                    <span class="detail-label">💺</span>
                    <span>좌석수: ${library.seatCo}석</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">📚</span>
                    <span>장서수: ${library.bookCo}권</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">🏢</span>
                    <span>운영기관: ${library.operInstitutionNm}</span>
                </div>
            `;

            // 지도 초기화 및 표시
            if (!detailMap) {
                detailMap = L.map('detailMap');
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(detailMap);
            }

            if (library.latitude && library.longitude) {
                const latLng = [library.latitude, library.longitude];
                detailMap.setView(latLng, 16);
                L.marker(latLng).addTo(detailMap);
            }

            setTimeout(() => {
                detailMap.invalidateSize();
            }, 100);
        }

        function closeModal() {
            const modal = document.getElementById('libraryModal');
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('libraryModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        function isLibraryOpen(library) {
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();
            const currentTime = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            const day = now.getDay();
            
            const isWeekend = day === 0 || day === 6;
            const openTime = isWeekend ? library.satOperOperOpenHhmm : library.weekdayOperOpenHhmm;
            const closeTime = isWeekend ? library.satOperCloseHhmm : library.weekdayOperColseHhmm;
            
            return currentTime >= openTime && currentTime <= closeTime;
        }

        function clearMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
        }

        function addMarker(library) {
            if (library.latitude && library.longitude) {
                const marker = L.marker([library.latitude, library.longitude])
                    .bindPopup(`
                        <b>${library.lbrryNm}</b><br>
                        ${library.rdnmadr || library.lnmadr}<br>
                        평일: ${library.weekdayOperOpenHhmm} - ${library.weekdayOperColseHhmm}
                    `);
                markers.push(marker);
                marker.addTo(map);
            }
        }

        function displayResults(libraries) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            clearMarkers();

            if (!libraries || libraries.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">검색 결과가 없습니다</div>';
                return;
            }

            const bounds = [];

            libraries.forEach(library => {
                const isOpen = isLibraryOpen(library);
                const card = document.createElement('div');
                card.className = 'library-card';

                if (library.latitude && library.longitude) {
                    bounds.push([library.latitude, library.longitude]);
                }

                card.onclick = () => {
                    showModal(library);
                };

                card.innerHTML = `
                    <div class="library-name">
                        <span class="library-type">${library.lbrrySe || '도서관'}</span>
                        ${library.lbrryNm}
                        <span class="status-badge ${isOpen ? 'status-open' : 'status-closed'}">
                            ${isOpen ? '운영중' : '휴관중'}
                        </span>
                    </div>
                    <div class="operation-hours">
                        <div class="library-info">
                            <span>⏰</span> 평일: ${library.weekdayOperOpenHhmm} - ${library.weekdayOperColseHhmm}
                        </div>
                        <div class="library-info">
                            <span>📅</span> 토요일: ${library.satOperOperOpenHhmm || '휴관'} - ${library.satOperCloseHhmm || '휴관'}
                        </div>
                        <div class="library-info">
                            <span>🚫</span> 휴관일: ${library.closeDay || '정보없음'}
                        </div>
                    </div>
                    <div class="library-info">
                        <span>📍</span> ${library.rdnmadr || library.lnmadr || '주소 정보 없음'}
                    </div>
                    <div class="library-info">
                        <span>📞</span> ${library.phoneNumber || '정보없음'}
                    </div>
                `;

                resultsDiv.appendChild(card);
                addMarker(library);
            });

            if (bounds.length > 0) {
                map.fitBounds(bounds);
            }
        }
    </script>
</body>
</html> 